"use strict";(()=>{var e={};e.id=132,e.ids=[132],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},852:e=>{e.exports=require("async_hooks")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},7147:e=>{e.exports=require("fs")},3292:e=>{e.exports=require("fs/promises")},2037:e=>{e.exports=require("os")},1017:e=>{e.exports=require("path")},6224:e=>{e.exports=require("tty")},3837:e=>{e.exports=require("util")},1714:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>m,originalPathname:()=>k,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>d,serverHooks:()=>f,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>h});var a={};t.r(a),t.d(a,{GET:()=>l,runtime:()=>u});var s=t(2534),n=t(9409),o=t(6717),i=t(7445),c=t(8588),p=t(9609);let u="nodejs";async function l(e){let r=e.nextUrl.searchParams,t=r.get("code"),a=r.get("state");if(r.get("error")||!t||!a)return i.Z.redirect(new URL("/settings/integracoes?error=access_denied",e.url));try{let{workspaceId:r}=JSON.parse((0,p.p)(a)),s=process.env.IG_APP_ID,n=process.env.IG_APP_SECRET,o=process.env.IG_REDIRECT_URI,u=new URLSearchParams;u.append("client_id",s),u.append("client_secret",n),u.append("grant_type","authorization_code"),u.append("redirect_uri",o),u.append("code",t);let l=await fetch("https://api.instagram.com/oauth/access_token",{method:"POST",body:u}),d=await l.json();if(!l.ok)throw console.error("IG Token Error",d),Error(d.error_message||"Failed to exchange token");let g=await fetch(`https://graph.instagram.com/access_token?grant_type=ig_exchange_token&client_secret=${n}&access_token=${d.access_token}`),_=await g.json(),f=_.access_token||d.access_token,m=_.expires_in||3600,h=new Date(Date.now()+1e3*m),k=await fetch(`https://graph.instagram.com/v21.0/me?fields=id,username,profile_picture_url&access_token=${f}`),x=await k.json();k.ok||console.error("IG Me Error",x);let v=x.id||d.user_id;return await c._.instagramAccount.upsert({where:{workspaceId_igUserId:{workspaceId:r,igUserId:String(v)}},update:{username:x.username||"Linked Account",profilePicUrl:x.profile_picture_url||"",status:"CONNECTED",accessTokenEncrypted:(0,p.H)(f),tokenExpiresAt:h,updatedAt:new Date},create:{workspaceId:r,igUserId:String(v),username:x.username||"Linked Account",profilePicUrl:x.profile_picture_url||"",status:"CONNECTED",accessTokenEncrypted:(0,p.H)(f),tokenExpiresAt:h}}),i.Z.redirect(new URL("/settings/integracoes?success=true",e.url))}catch(r){return console.error(r),i.Z.redirect(new URL("/settings/integracoes?error=server_error",e.url))}}let d=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/instagram/callback/route",pathname:"/api/instagram/callback",filename:"route",bundlePath:"app/api/instagram/callback/route"},resolvedPagePath:"C:\\dev\\Creatye v2\\apps\\web\\src\\app\\api\\instagram\\callback\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:_,serverHooks:f,headerHooks:m,staticGenerationBailout:h}=d,k="/api/instagram/callback/route";function x(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:_})}},9609:(e,r,t)=>{t.d(r,{H:()=>i,p:()=>c});var a=t(6113),s=t.n(a);let n="aes-256-cbc",o=process.env.APP_ENCRYPTION_KEY||"12345678901234567890123456789012";function i(e){let r=s().randomBytes(16),t=s().createCipheriv(n,Buffer.from(o),r),a=t.update(e);return a=Buffer.concat([a,t.final()]),r.toString("hex")+":"+a.toString("hex")}function c(e){let r=e.split(":"),t=Buffer.from(r.shift(),"hex"),a=Buffer.from(r.join(":"),"hex"),i=s().createDecipheriv(n,Buffer.from(o),t),c=i.update(a);return(c=Buffer.concat([c,i.final()])).toString()}},8588:(e,r,t)=>{t.d(r,{_:()=>s});var a=t(7699);let s=globalThis.prisma||new a.PrismaClient}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[150,343,363],()=>t(1714));module.exports=a})();