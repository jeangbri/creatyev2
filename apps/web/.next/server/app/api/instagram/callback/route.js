"use strict";(()=>{var e={};e.id=132,e.ids=[132],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},62812:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>C,originalPathname:()=>T,patchFetch:()=>A,requestAsyncStorage:()=>S,routeModule:()=>E,serverHooks:()=>b,staticGenerationAsyncStorage:()=>v,staticGenerationBailout:()=>R});var r={};a.r(r),a.d(r,{GET:()=>k,POST:()=>I,dynamic:()=>_,runtime:()=>y});var o=a(22534),n=a(79409),i=a(36717),s=a(27445),c=a(10027),l=a(59609);let d="https://graph.instagram.com/v21.0";async function p(e,t){let a=e.object;if("instagram"===a||"page"===a)for(let t of e.entry){t.id;let e=t.messaging||t.changes;if(e)for(let a of e)a.message&&await g(t.id,a),"comments"===a.field&&await u(t.id,a)}}async function u(e,t){let a=t.value,r=a.from.id,o=a.media.id,n=a.id,i=a.text||"";console.log(`[IG Service] Handling Comment. mediaId=${o}, text="${i}"`);let s=await c._.instagramAccount.findFirst({where:{igUserId:e},include:{workspace:!0}});if(!s){console.warn(`[IG Service] Account not found for comment entryId: ${e}`);return}let l=await c._.webhookEvent.create({data:{workspaceId:s.workspaceId,platform:"INSTAGRAM",eventType:"FEED_COMMENT",platformEventId:n,payloadJson:t,signatureValid:!0,processingStatus:"PROCESSING"}});for(let e of(await c._.workflow.findMany({where:{workspaceId:s.workspaceId,isActive:!0,status:"PUBLISHED",triggers:{some:{type:"FEED_COMMENT"}}},include:{triggers:!0,actions:!0}}))){let t=e.triggers.find(e=>"FEED_COMMENT"===e.type);if(!t)continue;let a=t.configJson,c=a.keywords,d=a.matchMode||"contains",p=a.posts||[];if(p.length>0&&!p.includes(o))continue;let u=!1;if(c&&0!==c.length){let e=i.toLowerCase();u="exact"===d?c.some(t=>t.toLowerCase().trim()===e):c.some(t=>e.includes(t.toLowerCase().trim()))}else u=!0;u&&await m(e,s,r,l.id,n)}await c._.webhookEvent.update({where:{id:l.id},data:{processingStatus:"DONE",processedAt:new Date}})}async function g(e,t){let a=t.sender.id,r=t.recipient.id,o=t.message;if(o.is_echo)return;let n=o.text||"",i=!!(t.message.reply_to&&t.message.reply_to.story),s=i?"STORY_REPLY":"DM_RECEIVED";console.log(`[IG Service] Handling DM. isStoryReply=${i}, targetTriggerType=${s}, text="${n}"`);let d=await c._.instagramAccount.findFirst({where:{igUserId:r},include:{workspace:!0}});if(!d){console.warn(`[IG Service] Account not found directly for recipientId: ${r}. Attempting resolution via tokens...`);let e=await c._.instagramAccount.findMany({where:{status:"CONNECTED"}}),t=null;for(let a of e)try{let e=(0,l.p)(a.accessTokenEncrypted),o=`https://graph.instagram.com/v21.0/${r}?fields=id,username&access_token=${e}`,n=await fetch(o);if(n.ok&&(await n.json()).username===a.username){console.log(`[IG Service] ID Mismatch Resolved! stored=${a.igUserId}, incoming=${r}. Updating DB...`),t=await c._.instagramAccount.update({where:{id:a.id},data:{igUserId:r}}),t=await c._.instagramAccount.findUnique({where:{id:a.id},include:{workspace:!0}});break}}catch(e){}if(!t){console.error(`[IG Service] Failed to resolve account for recipientId: ${r}`),console.log("ALL AVAILABLE ACCOUNTS (Failed resolution):",JSON.stringify(e.map(e=>({id:e.id,igUserId:e.igUserId,username:e.username}))));return}d=t}if(!d)return;let p=await c._.webhookEvent.create({data:{workspaceId:d.workspaceId,platform:"INSTAGRAM",eventType:i?"STORY_REPLY":"DM_RECEIVED",platformEventId:t.mid||`dm_${Date.now()}_${Math.random()}`,payloadJson:t,signatureValid:!0,processingStatus:"PROCESSING"}});for(let e of(await c._.workflow.findMany({where:{workspaceId:d.workspaceId,isActive:!0,status:"PUBLISHED",triggers:{some:{type:s}}},include:{triggers:!0,actions:!0}}))){let t=e.triggers.find(e=>e.type===s);if(!t)continue;let r=t.configJson,o=r.keywords,i=r.matchMode||"contains",c=!1;if(o&&0!==o.length){let e=n.toLowerCase();c="exact"===i?o.some(t=>t.toLowerCase().trim()===e):o.some(t=>e.includes(t.toLowerCase().trim()))}else c=!0;c&&await m(e,d,a,p.id)}await c._.webhookEvent.update({where:{id:p.id},data:{processingStatus:"DONE",processedAt:new Date}})}async function m(e,t,a,r,o){let n=await c._.automationRun.create({data:{workflowId:e.id,webhookEventId:r,status:"RUNNING"}});try{for(let r of e.actions)if("SEND_DM"===r.type||"REPLY_COMMENT"===r.type){let e=r.configJson,n=e.replyMessage,i=e.buttons||[];if((!i||0===i.length)&&e.cta&&e.cta.enabled&&e.cta.text&&e.cta.url&&(i=[{label:e.cta.text,url:e.cta.url,type:"web_url"}]),n){if(o)try{await w(t,o,n,i)}catch(e){console.error("Private Reply failed, attempting standard DM fallback",e),await f(t,a,n,i)}else await f(t,a,n,i)}o&&e.enableCommentReply&&e.commentReplyMessage&&await h(t,o,e.commentReplyMessage)}await c._.automationRun.update({where:{id:n.id},data:{status:"SUCCESS",finishedAt:new Date}})}catch(e){console.error("Error executing workflow",e),await c._.automationRun.update({where:{id:n.id},data:{status:"ERROR",finishedAt:new Date,errorMessage:e.message}})}}async function f(e,t,a,r){let o,n=(0,l.p)(e.accessTokenEncrypted).trim();console.log(`[IG Service] Sending DM to ${t}. Buttons: ${r?.length||0}`);let i=`${d}/me/messages?access_token=${n}`;o=r&&r.length>0?{recipient:{id:t},message:{attachment:{type:"template",payload:{template_type:"button",text:a,buttons:r.map(e=>({type:"web_url",url:e.url,title:e.label}))}}}}:{recipient:{id:t},message:{text:a}};let s=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),c=await s.json();if(!s.ok)throw console.error("[IG Service] DM Send Failed:",JSON.stringify(c)),Error(`Failed to send DM: ${JSON.stringify(c)}`);return c}async function w(e,t,a,r){let o,n=(0,l.p)(e.accessTokenEncrypted).trim();console.log(`[IG Service] Sending Private Reply to Comment ${t}. Buttons: ${r?.length||0}`);let i=`${d}/me/messages?access_token=${n}`;o=r&&r.length>0?{recipient:{comment_id:t},message:{attachment:{type:"template",payload:{template_type:"button",text:a,buttons:r.map(e=>({type:"web_url",url:e.url,title:e.label}))}}}}:{recipient:{comment_id:t},message:{text:a}};let s=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),c=await s.json();if(!s.ok)throw console.error("[IG Service] Private Reply Failed:",JSON.stringify(c)),Error(`Failed to send Private Reply: ${JSON.stringify(c)}`);return c}async function h(e,t,a){let r=(0,l.p)(e.accessTokenEncrypted).trim();console.log(`[IG Service] Public Reply to Comment ${t}.`);let o=`${d}/${t}/replies?access_token=${r}`,n=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:a})}),i=await n.json();if(!n.ok)throw console.error("[IG Service] Public Comment Reply Failed:",JSON.stringify(i)),Error(`Failed to reply to comment: ${JSON.stringify(i)}`);return i}let y="nodejs",_="force-dynamic";async function k(e){let t=e.nextUrl.searchParams,a=t.get("hub.mode"),r=t.get("hub.verify_token"),o=t.get("hub.challenge");if("subscribe"===a)return r===process.env.IG_VERIFY_TOKEN&&o?new s.Z(o,{status:200,headers:{"content-type":"text/plain; charset=utf-8"}}):new s.Z("Forbidden",{status:403});let n=t.get("code"),i=t.get("state");if(t.get("error")||!n||!i)return s.Z.redirect(new URL("/settings/integracoes?error=access_denied",e.url));try{let{workspaceId:t}=JSON.parse((0,l.p)(i)),a=process.env.IG_APP_ID,r=process.env.IG_APP_SECRET,o=process.env.IG_REDIRECT_URI,d=new URLSearchParams;d.append("client_id",a),d.append("client_secret",r),d.append("grant_type","authorization_code"),d.append("redirect_uri",o),d.append("code",n);let p=await fetch("https://api.instagram.com/oauth/access_token",{method:"POST",body:d}),u=await p.json();if(!p.ok)throw console.error("IG Token Error",u),Error(u.error_message||"Failed to exchange token");console.log("[IG Callback] Token exchanged successfully.");let g=await fetch(`https://graph.instagram.com/access_token?grant_type=ig_exchange_token&client_secret=${r}&access_token=${u.access_token}`),m=await g.json();console.log("[IG Callback] Long-lived token fetched.");let f=m.access_token||u.access_token,w=m.expires_in||3600,h=new Date(Date.now()+1e3*w),y=await fetch(`https://graph.instagram.com/v21.0/me?fields=id,username,profile_picture_url&access_token=${f}`),_=await y.json();console.log("[IG Callback] Me Data fetched:",_),y.ok||console.error("[IG Callback] Me Error",_);let k=_.id||u.user_id;console.log(`[IG Callback] Saving account. Workspace: ${t}, IG User ID: ${k}`);let I=await c._.instagramAccount.upsert({where:{workspaceId_igUserId:{workspaceId:t,igUserId:String(k)}},update:{username:_.username||"Linked Account",profilePicUrl:_.profile_picture_url||"",status:"CONNECTED",accessTokenEncrypted:(0,l.H)(f),tokenExpiresAt:h,updatedAt:new Date},create:{workspaceId:t,igUserId:String(k),username:_.username||"Linked Account",profilePicUrl:_.profile_picture_url||"",status:"CONNECTED",accessTokenEncrypted:(0,l.H)(f),tokenExpiresAt:h}});return console.log("[IG Callback] Account saved successfully:",I.id),s.Z.redirect(new URL("/settings/integracoes?success=true",e.url))}catch(t){return console.error("[IG Callback] CRITICAL ERROR:",t),s.Z.redirect(new URL("/settings/integracoes?error=server_error",e.url))}}async function I(e){try{let t=await e.json(),a=e.headers.get("x-hub-signature-256");return await p(t,a),s.Z.json({ok:!0})}catch(e){return console.error("Webhook POST Error",e),s.Z.json({ok:!1},{status:500})}}let E=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/instagram/callback/route",pathname:"/api/instagram/callback",filename:"route",bundlePath:"app/api/instagram/callback/route"},resolvedPagePath:"C:\\dev\\Creatye v2\\apps\\web\\src\\app\\api\\instagram\\callback\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:S,staticGenerationAsyncStorage:v,serverHooks:b,headerHooks:C,staticGenerationBailout:R}=E,T="/api/instagram/callback/route";function A(){return(0,i.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:v})}},59609:(e,t,a)=>{a.d(t,{H:()=>s,p:()=>c});var r=a(6113),o=a.n(r);let n="aes-256-cbc",i=process.env.APP_ENCRYPTION_KEY||"12345678901234567890123456789012";function s(e){let t=o().randomBytes(16),a=o().createCipheriv(n,Buffer.from(i),t),r=a.update(e);return r=Buffer.concat([r,a.final()]),t.toString("hex")+":"+r.toString("hex")}function c(e){let t=e.split(":"),a=Buffer.from(t.shift(),"hex"),r=Buffer.from(t.join(":"),"hex"),s=o().createDecipheriv(n,Buffer.from(i),a),c=s.update(r);return(c=Buffer.concat([c,s.final()])).toString()}},10027:(e,t,a)=>{a.d(t,{_:()=>o});let r=require("@prisma/client"),o=globalThis.prisma??new r.PrismaClient({log:["error","warn"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[150,363],()=>a(62812));module.exports=r})();