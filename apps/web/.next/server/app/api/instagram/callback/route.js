"use strict";(()=>{var e={};e.id=132,e.ids=[132],e.modules={3524:e=>{e.exports=require("@prisma/client")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},2812:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>E,originalPathname:()=>S,patchFetch:()=>C,requestAsyncStorage:()=>_,routeModule:()=>k,serverHooks:()=>y,staticGenerationAsyncStorage:()=>I,staticGenerationBailout:()=>v});var a={};r.r(a),r.d(a,{GET:()=>h,POST:()=>w,dynamic:()=>m,runtime:()=>f});var n=r(2534),o=r(9409),s=r(6717),i=r(7445),c=r(8588),l=r(9609);async function d(e,t){let r=e.object;if("instagram"===r||"page"===r)for(let t of e.entry){t.id;let e=t.messaging||t.changes;if(e)for(let r of e)r.message&&await u(t.id,r)}}async function u(e,t){let r=t.sender.id,a=t.recipient.id,n=t.message;if(n.is_echo)return;let o=n.text||"",s=!!(t.message.reply_to&&t.message.reply_to.story),i=s?"STORY_REPLY":"DM_RECEIVED";console.log(`[IG Service] Handling DM. isStoryReply=${s}, targetTriggerType=${i}, text="${o}"`);let d=await c._.instagramAccount.findFirst({where:{igUserId:a},include:{workspace:!0}});if(!d){console.warn(`[IG Service] Account not found directly for recipientId: ${a}. Attempting resolution via tokens...`);let e=await c._.instagramAccount.findMany({where:{status:"CONNECTED"}}),t=null;for(let r of e)try{let e=(0,l.p)(r.accessTokenEncrypted),n=`https://graph.instagram.com/v21.0/${a}?fields=id,username&access_token=${e}`,o=await fetch(n);if(o.ok&&(await o.json()).username===r.username){console.log(`[IG Service] ID Mismatch Resolved! stored=${r.igUserId}, incoming=${a}. Updating DB...`),t=await c._.instagramAccount.update({where:{id:r.id},data:{igUserId:a}}),t=await c._.instagramAccount.findUnique({where:{id:r.id},include:{workspace:!0}});break}}catch(e){}if(!t){console.error(`[IG Service] Failed to resolve account for recipientId: ${a}`),console.log("ALL AVAILABLE ACCOUNTS (Failed resolution):",JSON.stringify(e.map(e=>({id:e.id,igUserId:e.igUserId,username:e.username}))));return}d=t}if(!d)return;let u=await c._.webhookEvent.create({data:{workspaceId:d.workspaceId,platform:"INSTAGRAM",eventType:s?"STORY_REPLY":"DM_RECEIVED",platformEventId:t.mid||`dm_${Date.now()}_${Math.random()}`,payloadJson:t,signatureValid:!0,processingStatus:"PROCESSING"}});for(let e of(await c._.workflow.findMany({where:{workspaceId:d.workspaceId,isActive:!0,status:"PUBLISHED",triggers:{some:{type:i}}},include:{triggers:!0,actions:!0}}))){let t=e.triggers.find(e=>e.type===i);if(!t)continue;let a=t.configJson,n=a.keywords,s=a.matchMode||"contains",c=!1;if(n&&0!==n.length){let e=o.toLowerCase();c="exact"===s?n.some(t=>t.toLowerCase().trim()===e):n.some(t=>e.includes(t.toLowerCase().trim()))}else c=!0;c&&await p(e,d,r,u.id)}await c._.webhookEvent.update({where:{id:u.id},data:{processingStatus:"DONE",processedAt:new Date}})}async function p(e,t,r,a){let n=await c._.automationRun.create({data:{workflowId:e.id,webhookEventId:a,status:"RUNNING"}});try{for(let a of e.actions)if("SEND_DM"===a.type){let e=a.configJson.replyMessage;e&&await g(t,r,e)}await c._.automationRun.update({where:{id:n.id},data:{status:"SUCCESS",finishedAt:new Date}})}catch(e){console.error("Error executing workflow",e),await c._.automationRun.update({where:{id:n.id},data:{status:"ERROR",finishedAt:new Date,errorMessage:e.message}})}}async function g(e,t,r){let a=(0,l.p)(e.accessTokenEncrypted).trim();console.log(`[IG Service] Sending DM with token prefix: ${a.substring(0,10)}... (Length: ${a.length})`);let n=`https://graph.instagram.com/v21.0/me/messages?access_token=${a}`,o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recipient:{id:t},message:{text:r}})}),s=await o.json();if(!o.ok)throw console.error("[IG Service] DM Send Failed:",JSON.stringify(s)),Error(`Failed to send DM: ${JSON.stringify(s)}`);return s}let f="nodejs",m="force-dynamic";async function h(e){let t=e.nextUrl.searchParams,r=t.get("hub.mode"),a=t.get("hub.verify_token"),n=t.get("hub.challenge");if("subscribe"===r)return a===process.env.IG_VERIFY_TOKEN&&n?new i.Z(n,{status:200,headers:{"content-type":"text/plain; charset=utf-8"}}):new i.Z("Forbidden",{status:403});let o=t.get("code"),s=t.get("state");if(t.get("error")||!o||!s)return i.Z.redirect(new URL("/settings/integracoes?error=access_denied",e.url));try{let{workspaceId:t}=JSON.parse((0,l.p)(s)),r=process.env.IG_APP_ID,a=process.env.IG_APP_SECRET,n=process.env.IG_REDIRECT_URI,d=new URLSearchParams;d.append("client_id",r),d.append("client_secret",a),d.append("grant_type","authorization_code"),d.append("redirect_uri",n),d.append("code",o);let u=await fetch("https://api.instagram.com/oauth/access_token",{method:"POST",body:d}),p=await u.json();if(!u.ok)throw console.error("IG Token Error",p),Error(p.error_message||"Failed to exchange token");console.log("[IG Callback] Token exchanged successfully.");let g=await fetch(`https://graph.instagram.com/access_token?grant_type=ig_exchange_token&client_secret=${a}&access_token=${p.access_token}`),f=await g.json();console.log("[IG Callback] Long-lived token fetched.");let m=f.access_token||p.access_token,h=f.expires_in||3600,w=new Date(Date.now()+1e3*h),k=await fetch(`https://graph.instagram.com/v21.0/me?fields=id,username,profile_picture_url&access_token=${m}`),_=await k.json();console.log("[IG Callback] Me Data fetched:",_),k.ok||console.error("[IG Callback] Me Error",_);let I=_.id||p.user_id;console.log(`[IG Callback] Saving account. Workspace: ${t}, IG User ID: ${I}`);let y=await c._.instagramAccount.upsert({where:{workspaceId_igUserId:{workspaceId:t,igUserId:String(I)}},update:{username:_.username||"Linked Account",profilePicUrl:_.profile_picture_url||"",status:"CONNECTED",accessTokenEncrypted:(0,l.H)(m),tokenExpiresAt:w,updatedAt:new Date},create:{workspaceId:t,igUserId:String(I),username:_.username||"Linked Account",profilePicUrl:_.profile_picture_url||"",status:"CONNECTED",accessTokenEncrypted:(0,l.H)(m),tokenExpiresAt:w}});return console.log("[IG Callback] Account saved successfully:",y.id),i.Z.redirect(new URL("/settings/integracoes?success=true",e.url))}catch(t){return console.error("[IG Callback] CRITICAL ERROR:",t),i.Z.redirect(new URL("/settings/integracoes?error=server_error",e.url))}}async function w(e){try{let t=await e.json(),r=e.headers.get("x-hub-signature-256");return await d(t,r),i.Z.json({ok:!0})}catch(e){return console.error("Webhook POST Error",e),i.Z.json({ok:!1},{status:500})}}let k=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/instagram/callback/route",pathname:"/api/instagram/callback",filename:"route",bundlePath:"app/api/instagram/callback/route"},resolvedPagePath:"C:\\dev\\Creatye v2\\apps\\web\\src\\app\\api\\instagram\\callback\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:I,serverHooks:y,headerHooks:E,staticGenerationBailout:v}=k,S="/api/instagram/callback/route";function C(){return(0,s.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:I})}},9609:(e,t,r)=>{r.d(t,{H:()=>i,p:()=>c});var a=r(6113),n=r.n(a);let o="aes-256-cbc",s=process.env.APP_ENCRYPTION_KEY||"12345678901234567890123456789012";function i(e){let t=n().randomBytes(16),r=n().createCipheriv(o,Buffer.from(s),t),a=r.update(e);return a=Buffer.concat([a,r.final()]),t.toString("hex")+":"+a.toString("hex")}function c(e){let t=e.split(":"),r=Buffer.from(t.shift(),"hex"),a=Buffer.from(t.join(":"),"hex"),i=n().createDecipheriv(o,Buffer.from(s),r),c=i.update(a);return(c=Buffer.concat([c,i.final()])).toString()}},8588:(e,t,r)=>{r.d(t,{_:()=>n});var a=r(3524);let n=globalThis.prisma??new a.PrismaClient({log:["error","warn"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[150,363],()=>r(2812));module.exports=a})();