"use strict";(()=>{var e={};e.id=132,e.ids=[132],e.modules={3524:e=>{e.exports=require("@prisma/client")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},2812:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>R,originalPathname:()=>b,patchFetch:()=>A,requestAsyncStorage:()=>S,routeModule:()=>E,serverHooks:()=>C,staticGenerationAsyncStorage:()=>v,staticGenerationBailout:()=>T});var a={};r.r(a),r.d(a,{GET:()=>_,POST:()=>I,dynamic:()=>k,runtime:()=>y});var o=r(2534),n=r(9409),i=r(6717),s=r(7445),c=r(8588),l=r(9609);let d="https://graph.instagram.com/v21.0";async function p(e,t){let r=e.object;if("instagram"===r||"page"===r)for(let t of e.entry){t.id;let e=t.messaging||t.changes;if(e)for(let r of e)r.message&&await g(t.id,r),"comments"===r.field&&await u(t.id,r)}}async function u(e,t){let r=t.value,a=r.from.id,o=r.media.id,n=r.id,i=r.text||"";console.log(`[IG Service] Handling Comment. mediaId=${o}, text="${i}"`);let s=await c._.instagramAccount.findFirst({where:{igUserId:e},include:{workspace:!0}});if(!s){console.warn(`[IG Service] Account not found for comment entryId: ${e}`);return}let l=await c._.webhookEvent.create({data:{workspaceId:s.workspaceId,platform:"INSTAGRAM",eventType:"FEED_COMMENT",platformEventId:n,payloadJson:t,signatureValid:!0,processingStatus:"PROCESSING"}});for(let e of(await c._.workflow.findMany({where:{workspaceId:s.workspaceId,isActive:!0,status:"PUBLISHED",triggers:{some:{type:"FEED_COMMENT"}}},include:{triggers:!0,actions:!0}}))){let t=e.triggers.find(e=>"FEED_COMMENT"===e.type);if(!t)continue;let r=t.configJson,c=r.keywords,d=r.matchMode||"contains",p=r.posts||[];if(p.length>0&&!p.includes(o))continue;let u=!1;if(c&&0!==c.length){let e=i.toLowerCase();u="exact"===d?c.some(t=>t.toLowerCase().trim()===e):c.some(t=>e.includes(t.toLowerCase().trim()))}else u=!0;u&&await f(e,s,a,l.id,n)}await c._.webhookEvent.update({where:{id:l.id},data:{processingStatus:"DONE",processedAt:new Date}})}async function g(e,t){let r=t.sender.id,a=t.recipient.id,o=t.message;if(o.is_echo)return;let n=o.text||"",i=!!(t.message.reply_to&&t.message.reply_to.story),s=i?"STORY_REPLY":"DM_RECEIVED";console.log(`[IG Service] Handling DM. isStoryReply=${i}, targetTriggerType=${s}, text="${n}"`);let d=await c._.instagramAccount.findFirst({where:{igUserId:a},include:{workspace:!0}});if(!d){console.warn(`[IG Service] Account not found directly for recipientId: ${a}. Attempting resolution via tokens...`);let e=await c._.instagramAccount.findMany({where:{status:"CONNECTED"}}),t=null;for(let r of e)try{let e=(0,l.p)(r.accessTokenEncrypted),o=`https://graph.instagram.com/v21.0/${a}?fields=id,username&access_token=${e}`,n=await fetch(o);if(n.ok&&(await n.json()).username===r.username){console.log(`[IG Service] ID Mismatch Resolved! stored=${r.igUserId}, incoming=${a}. Updating DB...`),t=await c._.instagramAccount.update({where:{id:r.id},data:{igUserId:a}}),t=await c._.instagramAccount.findUnique({where:{id:r.id},include:{workspace:!0}});break}}catch(e){}if(!t){console.error(`[IG Service] Failed to resolve account for recipientId: ${a}`),console.log("ALL AVAILABLE ACCOUNTS (Failed resolution):",JSON.stringify(e.map(e=>({id:e.id,igUserId:e.igUserId,username:e.username}))));return}d=t}if(!d)return;let p=await c._.webhookEvent.create({data:{workspaceId:d.workspaceId,platform:"INSTAGRAM",eventType:i?"STORY_REPLY":"DM_RECEIVED",platformEventId:t.mid||`dm_${Date.now()}_${Math.random()}`,payloadJson:t,signatureValid:!0,processingStatus:"PROCESSING"}});for(let e of(await c._.workflow.findMany({where:{workspaceId:d.workspaceId,isActive:!0,status:"PUBLISHED",triggers:{some:{type:s}}},include:{triggers:!0,actions:!0}}))){let t=e.triggers.find(e=>e.type===s);if(!t)continue;let a=t.configJson,o=a.keywords,i=a.matchMode||"contains",c=!1;if(o&&0!==o.length){let e=n.toLowerCase();c="exact"===i?o.some(t=>t.toLowerCase().trim()===e):o.some(t=>e.includes(t.toLowerCase().trim()))}else c=!0;c&&await f(e,d,r,p.id)}await c._.webhookEvent.update({where:{id:p.id},data:{processingStatus:"DONE",processedAt:new Date}})}async function f(e,t,r,a,o){let n=await c._.automationRun.create({data:{workflowId:e.id,webhookEventId:a,status:"RUNNING"}});try{for(let a of e.actions)if("SEND_DM"===a.type||"REPLY_COMMENT"===a.type){let e=a.configJson,n=e.replyMessage;if(n){if(o)try{await w(t,o,n)}catch(e){console.error("Private Reply failed, attempting standard DM fallback",e),await m(t,r,n)}else await m(t,r,n)}o&&e.enableCommentReply&&e.commentReplyMessage&&await h(t,o,e.commentReplyMessage)}await c._.automationRun.update({where:{id:n.id},data:{status:"SUCCESS",finishedAt:new Date}})}catch(e){console.error("Error executing workflow",e),await c._.automationRun.update({where:{id:n.id},data:{status:"ERROR",finishedAt:new Date,errorMessage:e.message}})}}async function m(e,t,r){let a=(0,l.p)(e.accessTokenEncrypted).trim();console.log(`[IG Service] Sending DM to ${t}...`);let o=`${d}/me/messages?access_token=${a}`,n=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recipient:{id:t},message:{text:r}})}),i=await n.json();if(!n.ok)throw console.error("[IG Service] DM Send Failed:",JSON.stringify(i)),Error(`Failed to send DM: ${JSON.stringify(i)}`);return i}async function w(e,t,r){let a=(0,l.p)(e.accessTokenEncrypted).trim();console.log(`[IG Service] Sending Private Reply to Comment ${t}...`);let o=`${d}/me/messages?access_token=${a}`,n=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recipient:{comment_id:t},message:{text:r}})}),i=await n.json();if(!n.ok)throw console.error("[IG Service] Private Reply Failed:",JSON.stringify(i)),Error(`Failed to send Private Reply: ${JSON.stringify(i)}`);return i}async function h(e,t,r){let a=(0,l.p)(e.accessTokenEncrypted).trim();console.log(`[IG Service] Public Reply to Comment ${t}.`);let o=`${d}/${t}/replies?access_token=${a}`,n=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:r})}),i=await n.json();if(!n.ok)throw console.error("[IG Service] Public Comment Reply Failed:",JSON.stringify(i)),Error(`Failed to reply to comment: ${JSON.stringify(i)}`);return i}let y="nodejs",k="force-dynamic";async function _(e){let t=e.nextUrl.searchParams,r=t.get("hub.mode"),a=t.get("hub.verify_token"),o=t.get("hub.challenge");if("subscribe"===r)return a===process.env.IG_VERIFY_TOKEN&&o?new s.Z(o,{status:200,headers:{"content-type":"text/plain; charset=utf-8"}}):new s.Z("Forbidden",{status:403});let n=t.get("code"),i=t.get("state");if(t.get("error")||!n||!i)return s.Z.redirect(new URL("/settings/integracoes?error=access_denied",e.url));try{let{workspaceId:t}=JSON.parse((0,l.p)(i)),r=process.env.IG_APP_ID,a=process.env.IG_APP_SECRET,o=process.env.IG_REDIRECT_URI,d=new URLSearchParams;d.append("client_id",r),d.append("client_secret",a),d.append("grant_type","authorization_code"),d.append("redirect_uri",o),d.append("code",n);let p=await fetch("https://api.instagram.com/oauth/access_token",{method:"POST",body:d}),u=await p.json();if(!p.ok)throw console.error("IG Token Error",u),Error(u.error_message||"Failed to exchange token");console.log("[IG Callback] Token exchanged successfully.");let g=await fetch(`https://graph.instagram.com/access_token?grant_type=ig_exchange_token&client_secret=${a}&access_token=${u.access_token}`),f=await g.json();console.log("[IG Callback] Long-lived token fetched.");let m=f.access_token||u.access_token,w=f.expires_in||3600,h=new Date(Date.now()+1e3*w),y=await fetch(`https://graph.instagram.com/v21.0/me?fields=id,username,profile_picture_url&access_token=${m}`),k=await y.json();console.log("[IG Callback] Me Data fetched:",k),y.ok||console.error("[IG Callback] Me Error",k);let _=k.id||u.user_id;console.log(`[IG Callback] Saving account. Workspace: ${t}, IG User ID: ${_}`);let I=await c._.instagramAccount.upsert({where:{workspaceId_igUserId:{workspaceId:t,igUserId:String(_)}},update:{username:k.username||"Linked Account",profilePicUrl:k.profile_picture_url||"",status:"CONNECTED",accessTokenEncrypted:(0,l.H)(m),tokenExpiresAt:h,updatedAt:new Date},create:{workspaceId:t,igUserId:String(_),username:k.username||"Linked Account",profilePicUrl:k.profile_picture_url||"",status:"CONNECTED",accessTokenEncrypted:(0,l.H)(m),tokenExpiresAt:h}});return console.log("[IG Callback] Account saved successfully:",I.id),s.Z.redirect(new URL("/settings/integracoes?success=true",e.url))}catch(t){return console.error("[IG Callback] CRITICAL ERROR:",t),s.Z.redirect(new URL("/settings/integracoes?error=server_error",e.url))}}async function I(e){try{let t=await e.json(),r=e.headers.get("x-hub-signature-256");return await p(t,r),s.Z.json({ok:!0})}catch(e){return console.error("Webhook POST Error",e),s.Z.json({ok:!1},{status:500})}}let E=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/instagram/callback/route",pathname:"/api/instagram/callback",filename:"route",bundlePath:"app/api/instagram/callback/route"},resolvedPagePath:"C:\\dev\\Creatye v2\\apps\\web\\src\\app\\api\\instagram\\callback\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:S,staticGenerationAsyncStorage:v,serverHooks:C,headerHooks:R,staticGenerationBailout:T}=E,b="/api/instagram/callback/route";function A(){return(0,i.patchFetch)({serverHooks:C,staticGenerationAsyncStorage:v})}},9609:(e,t,r)=>{r.d(t,{H:()=>s,p:()=>c});var a=r(6113),o=r.n(a);let n="aes-256-cbc",i=process.env.APP_ENCRYPTION_KEY||"12345678901234567890123456789012";function s(e){let t=o().randomBytes(16),r=o().createCipheriv(n,Buffer.from(i),t),a=r.update(e);return a=Buffer.concat([a,r.final()]),t.toString("hex")+":"+a.toString("hex")}function c(e){let t=e.split(":"),r=Buffer.from(t.shift(),"hex"),a=Buffer.from(t.join(":"),"hex"),s=o().createDecipheriv(n,Buffer.from(i),r),c=s.update(a);return(c=Buffer.concat([c,s.final()])).toString()}},8588:(e,t,r)=>{r.d(t,{_:()=>o});var a=r(3524);let o=globalThis.prisma??new a.PrismaClient({log:["error","warn"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[150,363],()=>r(2812));module.exports=a})();